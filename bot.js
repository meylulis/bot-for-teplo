const { Telegraf, Markup } = require('telegraf');
const fs = require('fs');
require('dotenv').config();

const bot = new Telegraf(process.env.BOT_TOKEN);

// –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const DATA_FILE = 'data.json';

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
function loadData() {
    try {
        return JSON.parse(fs.readFileSync(DATA_FILE, 'utf8'));
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        return {};
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ JSON
function saveData(data) {
    fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2), 'utf8');
}

let usersData = loadData();

const achievements = {
    "–®–≤–µ–π–Ω–∞—è": [
        { name: "‚úÇÔ∏è –Æ–Ω—ã–π –ø–æ—Ä—Ç–Ω–æ–π", visits: 5 },
        { name: "üßµ –ú–∞—Å—Ç–µ—Ä –∏–≥–ª—ã", visits: 15 }
    ],
    "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π": [
        { name: "üá¨üáß Hello, world!", visits: 5 }
    ],
    "–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω": [
        { name: "üé® –¶–∏—Ñ—Ä–æ–≤–æ–π —Ö—É–¥–æ–∂–Ω–∏–∫", visits: 10 }
    ],
    "–°–ø–æ—Ä—Ç": [
        { name: "üèãÔ∏è –°–ø–æ—Ä—Ç—Å–º–µ–Ω-–ª—é–±–∏—Ç–µ–ª—å", visits: 5 },
        { name: "üèÜ –ñ–µ–ª–µ–∑–Ω—ã–π —á–µ–º–ø–∏–æ–Ω", visits: 20 }
    ],
    "–§–æ—Ç–æ—Å—Ç—É–¥–∏—è": [
        { name: "üì∏ –ú–∞—Å—Ç–µ—Ä –∫–∞–¥—Ä–∞", visits: 10 }
    ],
    "–î–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã": [
        { name: "üèõÔ∏è –ù–∞—Å—Ç–æ–ª—å–Ω—ã–π –¥–∏–ø–ª–æ–º–∞—Ç", visits: 10 }
    ],
    "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è": [
        { name: "üèÜ –ö–æ—Ä–æ–ª—å –≤–µ—á–µ—Ä–∏–Ω–æ–∫", visits: 15 }
    ],
    "–û–±—â–µ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ": [
        { name: "üåü –õ–µ–≥–µ–Ω–¥–∞ '–¢–µ–ø–ª–∞'", visits: 50 }
    ]
};

function checkAchievements(userId, activity) {
    if (!usersData[userId]) {
        usersData[userId] = { visits: {}, earnedAchievements: [], points: 0 };
    }

    // üî• –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–∞—Å—Å–∏–≤ earnedAchievements, –µ—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º
    if (!usersData[userId].earnedAchievements) {
        usersData[userId].earnedAchievements = [];
    }

    if (!usersData[userId].visits) {
        usersData[userId].visits = {};
    }

    if (!usersData[userId].visits[activity]) {
        usersData[userId].visits[activity] = 0;
    }

    usersData[userId].visits[activity]++;

    let newAchievements = [];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (achievements[activity]) {
        achievements[activity].forEach(ach => {
            if (usersData[userId].visits[activity] >= ach.visits &&
                !usersData[userId].earnedAchievements.includes(ach.name)) {
                
                usersData[userId].earnedAchievements.push(ach.name);
                newAchievements.push(ach.name);
            }
        });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π
    let totalVisits = Object.values(usersData[userId].visits).reduce((sum, num) => sum + num, 0);
    achievements["–û–±—â–µ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ"].forEach(ach => {
        if (totalVisits >= ach.visits &&
            !usersData[userId].earnedAchievements.includes(ach.name)) {
            
            usersData[userId].earnedAchievements.push(ach.name);
            newAchievements.push(ach.name);
        }
    });

    if (newAchievements.length > 0) {
        saveData(usersData);
        bot.telegram.sendMessage(userId, `üèÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –Ω–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:\n\n${newAchievements.map(a => `‚úÖ ${a}`).join("\n")}`, { parse_mode: 'Markdown' });
    }
}

// –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
const mainMenu = Markup.keyboard([
    ['üé≠ –ö—Ä—É–∂–∫–∏', 'üéâ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è'],
    ['üí∞ –ë–∞–ª–∞–Ω—Å', 'üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è'],
    ['üèÖ –ß–µ–ª–ª–µ–Ω–¥–∂–∏'],
    ['üéÅ –ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥', 'üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞']
]).resize();

// –ú–µ–Ω—é —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
const challengesMenu = Markup.keyboard([
    ['üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ —Å –≤—ã—Å—Ç–∞–≤–∫–∏', 'üñãÔ∏è –ò—Å–∫—É—Å—Å—Ç–≤–æ –≤ —Å–ª–æ–≤–∞—Ö'],
    ['üé• –¢—Ä–∞–ø–µ—Ü–∏—è –≤ –¥–µ–π—Å—Ç–≤–∏–∏'],
    ['üñºÔ∏è –í–∏—Ç—Ä–∞–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å', 'üí° –ò—Å—Ç–æ—Ä–∏—è –≤–∏—Ç—Ä–∞–∂–∞'],
    ['üé® –ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π —à–µ–¥–µ–≤—Ä', 'üõ†Ô∏è –¢—Ä—É–¥–Ω–æ—Å—Ç–∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞'],
    ['üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ –¥–ª—è –¥—É—à–∏', 'üéÅ –ü–æ–¥–∞—Ä–æ–∫ —Å–≤–æ–∏–º–∏ —Ä—É–∫–∞–º–∏'],
    ['üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥']
]).resize();

// –°–ø–∏—Å–æ–∫ –∫—Ä—É–∂–∫–æ–≤
const clubsMenu = Markup.keyboard([
    ['–®–≤–µ–π–Ω–∞—è', '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π'],
    ['–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω', '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã'],
    ['–°–ø–æ—Ä—Ç', '–ö–µ—Ä–∞–º–∏–∫–∞'],
    ['–§–æ—Ç–æ—Å—Ç—É–¥–∏—è', '–ö–æ—Å–ø–ª–µ–π'],
    ['–ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–æ–ª–æ–≥', '–¢–≤–æ—Ä—á–µ—Å–∫–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è'],
    ['üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥']
]).resize();

// –°–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
const eventsMenu = Markup.keyboard([
    ['–í—ã—Å—Ç–∞–≤–∫–∞ "–Ø —Ç–∞–∫ –≤–∏–∂—É"', '–°–∏–ª—å–Ω–∞—è —Ç—Ä–∞–ø–µ—Ü–∏—è'],
    ['–í–∏—Ç—Ä–∞–∂–Ω–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è', '–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–∏–¥–µ–ª–∫–∏'],
    ['–ê—Ä—Ç-—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è –≤—Å—Ç—Ä–µ—á–∞', '–¢–µ–ø–ª—ã–µ –º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ'],
    ['üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥']
]).resize();


// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function sendWelcomeMessage(ctx) {
    ctx.reply(
        `üî• –ü—Ä–∏–≤–µ—Ç, ${ctx.from.first_name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ "–¢–µ–ø–ª–æ"! üè°\n\n` +
        `üí° *–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞:*\n` +
        `üîπ /start - –ù–∞—á–Ω–∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–∞–ª–ª—ã –∏ —É—á–∞—Å—Ç–≤—É–π –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö üéâ\n` +
        `üîπ /reference - –£–∑–Ω–∞–π, —á—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑ —Å–µ–±—è —ç—Ç–æ—Ç –±–æ—Ç ‚ÑπÔ∏è\n\n` +
        `üîó *–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞—Ö–æ–¥–∏ –≤ –Ω–∞—à—É –≥—Ä—É–ø–ø—É –í–ö! –¢–∞–º —Ç—ã –Ω–∞–π–¥–µ—à—å –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ:*\n` +
        `[–ü–µ—Ä–µ–π—Ç–∏ –≤ –≥—Ä—É–ø–ø—É –í–ö](https://vk.com/mp_teplo)`, 
        { parse_mode: 'Markdown', ...mainMenu }
    );
}

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.start((ctx) => {
    sendWelcomeMessage(ctx);
});

// –ö–Ω–æ–ø–∫–∞ "–ö—Ä—É–∂–∫–∏"
bot.hears('üé≠ –ö—Ä—É–∂–∫–∏', (ctx) => {
    ctx.reply('üìç –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä—É–∂–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–µ—Ç–∏—Ç—å:', clubsMenu);
});

// –ö–Ω–æ–ø–∫–∞ "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è"
bot.hears('üéâ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', (ctx) => {
    ctx.reply('üìç –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–µ—Ç–∏—Ç—å:', eventsMenu);
});

// –ö–æ–º–∞–Ω–¥–∞ /reference
bot.command('reference', (ctx) => {
    ctx.reply(
        `‚ÑπÔ∏è *–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞ "–¢–µ–ø–ª–æ":*\n\n` +
        `üîπ /start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –æ—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üì≤\n` +
        `üîπ üèÜ *–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è* - –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏ —É–∑–Ω–∞–π –æ —Å–≤–æ–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ø–æ–ª—É—á–∏–ª \n` +
        `üîπ üí∞ *–ë–∞–ª–∞–Ω—Å* - –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏ —Ä–æ–≤–µ—Ä—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–æ–±–æ–π –±–∞–ª–ª–æ–≤ \n` +
        `üîπ üéÅ *–ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥* - –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏ —É–∑–Ω–∞–π, —Å–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ —Ç—ã –º–æ–∂–µ—à—å –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ —Ü–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑—ã \n` +
        `üèÖ *–ß–µ–ª–ª–µ–Ω–¥–∂–∏* - –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏ –ø–æ—É—á–∞—Å—Ç–≤—É–π –≤ —á–µ–ª–ª–µ–Ω–¥–∂–∞—Ö, —á—Ç–æ–± –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∞–ª–ª—ã \n` +
        `üîπ üîÑ *–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞* - –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ \n\n` +
        `‚úÖ –¢–µ–ø–µ—Ä—å —Ç–µ–±–µ –∏–∑–≤–µ—Å—Ç–Ω–æ –≤—Å–µ, –¥–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω –±–æ—Ç, —Å–∫–æ—Ä–µ–µ –∑–∞–ø–∏—à–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ! \n\n/start`, 
        { parse_mode: 'Markdown' }
    );
});


bot.hears('üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞', (ctx) => {
    sendWelcomeMessage(ctx);
});

bot.hears('üé≠ –ö—Ä—É–∂–∫–∏', (ctx) => {
    ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä—É–∂–æ–∫:', clubsMenu);
});

bot.hears('üéâ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', (ctx) => {
    ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:', eventsMenu);
});

bot.hears('üèÖ –ß–µ–ª–ª–µ–Ω–¥–∂–∏', (ctx) => {
    ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–ª–µ–Ω–¥–∂:', challengesMenu);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞ "–§–æ—Ç–æ–≥—Ä–∞—Ñ —Å –≤—ã—Å—Ç–∞–≤–∫–∏"
bot.hears('üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ —Å –≤—ã—Å—Ç–∞–≤–∫–∏', (ctx) => {
    const userId = ctx.from.id;

    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≥–æ—Ç–æ–≤–∏–º –µ–≥–æ –∫ —É—á–∞—Å—Ç–∏—é –≤ —á–µ–ª–ª–µ–Ω–¥–∂–µ
    if (!usersData[userId]) {
        usersData[userId] = {};
    }

    usersData[userId].status = 'waiting_for_exhibition_photos'; // –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
    usersData[userId].photoCount = 0; // –°—á—ë—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    saveData(usersData);

    ctx.reply('üì∏ –î–ª—è —É—á–∞—Å—Ç–∏—è –≤ —á–µ–ª–ª–µ–Ω–¥–∂–µ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–≤–∞ —Ñ–æ—Ç–æ —Å –≤—ã—Å—Ç–∞–≤–∫–∏. –í—ã –ø–æ–ª—É—á–∏—Ç–µ –∑–∞ —ç—Ç–æ 5 –±–∞–ª–ª–æ–≤.');
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —Ä–∞–º–∫–∞—Ö —á–µ–ª–ª–µ–Ω–¥–∂–∞ "–§–æ—Ç–æ–≥—Ä–∞—Ñ —Å –≤—ã—Å—Ç–∞–≤–∫–∏"
bot.on('photo', (ctx) => {
    const userId = ctx.from.id;
    const userState = usersData[userId];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —á–µ–ª–ª–µ–Ω–¥–∂–µ "–§–æ—Ç–æ–≥—Ä–∞—Ñ —Å –≤—ã—Å—Ç–∞–≤–∫–∏"
    if (!userState || userState.status !== 'waiting_for_exhibition_photos') {
        return;
    }

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Ñ–æ—Ç–æ
    userState.photoCount += 1;

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –¥–≤–∞ —Ñ–æ—Ç–æ, –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã
    if (userState.photoCount === 2) {
        // –ù–∞—á–∏—Å–ª—è–µ–º 5 –±–∞–ª–ª–æ–≤
        userState.points = (userState.points || 0) + 5;
        saveData(usersData);

        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
        userState.status = null;
        userState.photoCount = 0;
        saveData(usersData);

        // –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –æ–Ω –≤—ã–ø–æ–ª–Ω–∏–ª —á–µ–ª–ª–µ–Ω–¥–∂
        ctx.reply(
            `‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —á–µ–ª–ª–µ–Ω–¥–∂ "–§–æ—Ç–æ–≥—Ä–∞—Ñ —Å –≤—ã—Å—Ç–∞–≤–∫–∏"! üéâ\n\n` +
            `–í—ã –ø–æ–ª—É—á–∏–ª–∏ *5 –±–∞–ª–ª–æ–≤*! üí∞\n\n` +
            `üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: *${userState.points}* –±–∞–ª–ª–æ–≤.`,
            { parse_mode: 'Markdown' }
        );
    } else {
        // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –º–µ–Ω—å—à–µ –¥–≤—É—Ö, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
        ctx.reply(`üì∏ –í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ ${userState.photoCount} —Ñ–æ—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â—ë –æ–¥–Ω–æ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂.`);
    }
});


// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∫—Ä—É–∂–∫–æ–≤ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
const activities = [
    "–®–≤–µ–π–Ω–∞—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω", "–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã", 
    "–°–ø–æ—Ä—Ç", "–ö–µ—Ä–∞–º–∏–∫–∞", "–§–æ—Ç–æ—Å—Ç—É–¥–∏—è", "–ö–æ—Å–ø–ª–µ–π", "–ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–æ–ª–æ–≥", 
    "–¢–≤–æ—Ä—á–µ—Å–∫–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è", "–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–∏–¥–µ–ª–∫–∏", "–í–∏—Ç—Ä–∞–∂–Ω–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è",
    "–ê—Ä—Ç-—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è –≤—Å—Ç—Ä–µ—á–∞", "–¢–µ–ø–ª—ã–µ –º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ", "–°–∏–ª—å–Ω–∞—è —Ç—Ä–∞–ø–µ—Ü–∏—è"
];


// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫—Ä—É–∂–∫–∞/–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
activities.forEach(activity => {
    bot.hears(activity, (ctx) => {
        const userId = ctx.from.id;

        if (!usersData[userId]) {
            usersData[userId] = { points: 0 };
        }

        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—Ä—É–∂–æ–∫/–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
        usersData[userId].activity = activity;
        saveData(usersData);

        ctx.reply(
            `üì∑ –í—ã –≤—ã–±—Ä–∞–ª–∏ *${activity}*.\n` +
            `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è/–∫—Ä—É–∂–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å –Ω–µ–≥–æ –∏ –ø–æ–ª—É—á–∏—Ç–µ *10 –±–∞–ª–ª–æ–≤*!`, 
            { parse_mode: 'Markdown' });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        checkAchievements(userId, activity);
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ
bot.on('photo', (ctx) => {
    const userId = ctx.from.id;
    const userState = usersData[userId];

    if (!userState || !userState.activity) {
        ctx.reply('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—Ä—É–∂–æ–∫ –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ç–æ!');
        return;
    }

    // –ù–∞—á–∏—Å–ª—è–µ–º 10 –±–∞–ª–ª–æ–≤
    usersData[userId].points = (usersData[userId].points || 0) + 10;
    saveData(usersData);

    ctx.reply(
        `‚úÖ –§–æ—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ! –í—ã –ø–æ–ª—É—á–∏–ª–∏ *10 –±–∞–ª–ª–æ–≤*! üéâ\n\n` +
        `üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: *${usersData[userId].points}* –±–∞–ª–ª–æ–≤.`, 
        { parse_mode: 'Markdown' }
    );

    // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫—Ä—É–∂–æ–∫/–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    delete usersData[userId].activity;
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã "–ë–∞–ª–∞–Ω—Å"
bot.hears('üí∞ –ë–∞–ª–∞–Ω—Å', (ctx) => {
    const userId = ctx.from.id;
    const userPoints = usersData[userId]?.points || 0; // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    ctx.reply(`üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: *${userPoints}* –±–∞–ª–ª–æ–≤.`, { parse_mode: 'Markdown' });
}); 

bot.hears('üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', (ctx) => {
    const userId = ctx.from.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    const userAch = usersData[userId]?.earnedAchievements || [];

    if (userAch.length === 0) {
        ctx.reply('üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –∫—Ä—É–∂–∫–∏, —á—Ç–æ–±—ã –∏—Ö –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å!');
    } else {
        ctx.reply(`üèÖ –í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:\n\n${userAch.map(a => `‚úÖ ${a}`).join("\n")}`);
    }
});

// –ü—Ä–∏–º–µ—Ä —Å–ø–∏—Å–∫–∞ –Ω–∞–≥—Ä–∞–¥ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
const rewards = {
    "üéüÔ∏è –°—Ç–∏–∫–µ—Ä": 20,
    "üéÅ –ë—Ä–µ–ª–æ–∫": 50,
    "üëï –§—É—Ç–±–æ–ª–∫–∞": 100
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã "–ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥"
bot.hears('üéÅ –ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥', (ctx) => {
    const userId = ctx.from.id;
    const userPoints = usersData[userId]?.points || 0;

    // –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏ —Å –Ω–∞–≥—Ä–∞–¥–∞–º–∏
    const rewardButtons = Object.keys(rewards).map(reward =>
        [Markup.button.callback(`${reward} ‚Äî ${rewards[reward]} –±–∞–ª–ª–æ–≤`, `reward_${reward}`)]
    );

    ctx.reply(
        `üéÅ *–ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥*\n\nüí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: *${userPoints}* –±–∞–ª–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–≥—Ä–∞–¥—É:`,
        {
            parse_mode: "Markdown",
            ...Markup.inlineKeyboard(rewardButtons)
        }
    );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞–≥—Ä–∞–¥
bot.action(/^reward_(.+)/, (ctx) => {
    const userId = ctx.from.id;
    const userPoints = usersData[userId]?.points || 0;
    const rewardName = ctx.match[1]; // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
    const rewardCost = rewards[rewardName];

    if (!rewardCost) {
        return ctx.answerCbQuery("‚ùå –¢–∞–∫–æ–π –Ω–∞–≥—Ä–∞–¥—ã –Ω–µ—Ç!");
    }

    if (userPoints >= rewardCost) {
        usersData[userId].points -= rewardCost; // –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã
        saveData(usersData); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è

        ctx.reply(`‚úÖ –í—ã –æ–±–º–µ–Ω—è–ª–∏ ${rewardCost} –±–∞–ª–ª–æ–≤ –Ω–∞ *${rewardName}*! üéâ. –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–± –∑–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ê–¥–º–∏–Ω—É "–¢–µ–ø–ª–æ"`, { parse_mode: "Markdown" });
    } else {
        ctx.answerCbQuery(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤! –ù—É–∂–Ω–æ –µ—â—ë ${rewardCost - userPoints} –±–∞–ª–ª–æ–≤.`);
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥"
bot.hears('üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥', (ctx) => {
    ctx.reply('–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.', mainMenu);
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch();
console.log('üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!');
